AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  Environment:
    Description: Name of the AWS deployment environment
    Type: String
  PipelineName:
    Description: Prefix for all resources generated by the pipeline
    Type: String
  Namespace:
    Description: Prefix for all resources generated by the pipeline
    Type: String
  VpcId:
    Description: VPC ID passed to resources, resolved via SSM
    Type: AWS::SSM::Parameter::Value<String>
  IslandSubnetA:
    Description: Subnets used for Service Template, passed via foundational.json
    Type: AWS::SSM::Parameter::Value<String>
  IslandSubnetB:
    Description: Subnets used for Service Template, passed via foundational.json
    Type: AWS::SSM::Parameter::Value<String>
  RoutableSubnetA:
    Description: Subnets used for Service Template, passed via foundational.json
    Type: AWS::SSM::Parameter::Value<String>
  RoutableSubnetB:
    Description: Subnets used for Service Template, passed via foundational.json
    Type: AWS::SSM::Parameter::Value<String>
  HookImage:
    Description: The container to run tasks in via hook
    Type: String
  Tag:
    Description: Used as the aws log stream prefix
    Type: String
  RunnerGroup:
    Description: The group name for the runner
    Type: String
  RunnerLabels:
    Description: Comma-seperated list of runner labels
    Type: String
  SSIPrefix:
    Description: Prefix used for resources needing boundary permissions
    Type: String

Resources:
  LogGroup:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: "./LogGroup.yml"
      Parameters:
        Namespace: !Ref Namespace

  Secrets:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: "./Secrets.yml"
      Parameters:
        Namespace: !Ref Namespace

  Roles:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: "./Roles.yml"
      Parameters:
        Namespace: !Ref Namespace
        GithubSecretArn: !GetAtt Secrets.Outputs.GitAccessToken
        HookSecretArn: !GetAtt Secrets.Outputs.GitHookSecret
        SSIPrefix: !Ref SSIPrefix

  SecurityGroups:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: "./SecurityGroups.yml"
      Parameters:
        Namespace: !Ref Namespace
        VpcId: !Ref VpcId

  RunnerHook:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: "./Serverless.yml"
      Parameters:
        Environment: !Ref Environment
        Namespace: !Ref Namespace
        ServerlessRoleArn: !GetAtt Roles.Outputs.RunnerHookRoleArn
        VpcId: !Ref VpcId
        IslandSubnetA: !Ref IslandSubnetA
        IslandSubnetB: !Ref IslandSubnetB
        RoutableSubnetA: !Ref RoutableSubnetA
        RoutableSubnetB: !Ref RoutableSubnetB
        EcsCluster: !Ref EcsCluster
        LogGroup: !GetAtt LogGroup.Outputs.LogGroup
        ContainerSecurityGroup: !GetAtt SecurityGroups.Outputs.ContainerSecurityGroup
        ServerlessSecurityGroup: !GetAtt SecurityGroups.Outputs.ServerlessSecurityGroup
        VPCESecurityGroup: !GetAtt SecurityGroups.Outputs.VPCESecurityGroup
        EcsTaskRoleArn: !GetAtt Roles.Outputs.EcsTaskRoleArn
        EcsTaskExecutionRoleArn: !GetAtt Roles.Outputs.EcsTaskExecutionRoleArn
        GitHookSecret: !GetAtt Secrets.Outputs.GitHookSecret
        GithubSecretArn: !GetAtt Secrets.Outputs.GitAccessToken
        RunnerGroup: !Ref RunnerGroup
        RunnerLabels: !Ref RunnerLabels
        Image: !Ref HookImage
        Tag: !Ref Tag

  EcsCluster:
    Type: "AWS::ECS::Cluster"
    Properties:
      ClusterName: !Ref Namespace
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

Outputs:
  PipelineName:
    Value: !Ref PipelineName
  Namespace:
    Value: !Ref Namespace
  Environment:
    Value: !Ref Environment
  WebHookUrl:
    Value: !GetAtt RunnerHook.Outputs.WebHookUrl
  Secret:
    Value: !GetAtt Secrets.Outputs.GitHookSecret
  GitAccessToken:
    Value: !GetAtt Secrets.Outputs.GitAccessToken
