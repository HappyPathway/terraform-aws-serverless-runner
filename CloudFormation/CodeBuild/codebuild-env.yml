AWSTemplateFormatVersion: "2010-09-09"
Description: CodeBuild jobs

Parameters:
  DeployerRoleName:
    Description: Role to use for pipeline
    Type: String
  Namespace:
    Description: Prefix for all resources generated by the pipeline
    Type: String
  BuildSpecDir:
    Description: Location of buildspec files for codebuild
    Type: String
  VpcId:
    Description: VPC ID passed to resources, resolved via SSM
    Type: AWS::SSM::Parameter::Value<String>
  IslandSubnetA:
    Description: Subnet ID passed to resources, resolved via SSM
    Type: AWS::SSM::Parameter::Value<String>
  IslandSubnetB:
    Description: Subnet ID passed to resources, resovled via SSM
    Type: AWS::SSM::Parameter::Value<String>

Resources:
  CodeBuildSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group used for Egress from CodeBuild
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: "-1"
          Description: Allow egress of anytype to anywhere
      VpcId: !Ref VpcId

  EnvRegister:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${Namespace}-registerhook"
      Description: Register webhook with github
      ServiceRole: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${DeployerRoleName}"
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        EnvironmentVariables:
          - Name: NAMESPACE
            Value: !Ref Namespace
          - Name: GITHUB_API_URL
            Value: "https://github.mmm.com/api/v3"
      Source:
        BuildSpec: !Sub ${BuildSpecDir}/registerhook-env.yml
        Type: CODEPIPELINE
      VpcConfig:
        SecurityGroupIds:
          - !Ref "CodeBuildSecurityGroup"
        Subnets:
          - !Ref IslandSubnetA
          - !Ref IslandSubnetB
        VpcId: !Ref VpcId
      TimeoutInMinutes: 10

  EnvUpdateSSIDeployer:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${Namespace}-update-ssi-envs-deployer
      Description: Updates SSI deployer product
      ServiceRole: !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${DeployerRoleName}"
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: !Sub ${BuildSpecDir}/build-ssi-deployer-updater.yml
      Environment:
        ComputeType: "BUILD_GENERAL1_SMALL"
        Image: aws/codebuild/amazonlinux2-x86_64-standard:4.0
        Type: "LINUX_CONTAINER"
      VpcConfig:
        SecurityGroupIds:
          - !Ref "CodeBuildSecurityGroup"
        Subnets:
          - !Ref IslandSubnetA
          - !Ref IslandSubnetB
        VpcId: !Ref VpcId
